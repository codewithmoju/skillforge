rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidString(value, minLen, maxLen) {
      return value is string && value.size() >= minLen && value.size() <= maxLen;
    }
    
    function isValidUsername(username) {
      return username is string && 
             username.size() >= 3 && 
             username.size() <= 30 &&
             username.matches('^[a-zA-Z0-9_]+$');
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated(); // Anyone can view profiles
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    // Usernames collection (for unique username lookup)
    match /usernames/{username} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       isValidUsername(username) &&
                       request.resource.data.uid == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.uid == request.auth.uid;
    }

    // Posts collection
    match /posts/{postId} {
      allow read: if isAuthenticated(); // Anyone can see posts
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.userId) &&
                       isValidString(request.resource.data.content.text, 0, 500);
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
      
      // Post likes subcollection
      match /likes/{likeId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
        allow delete: if isAuthenticated() && isOwner(resource.data.userId);
      }
      
      // Post comments subcollection
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && 
                         isOwner(request.resource.data.userId) &&
                         isValidString(request.resource.data.text, 1, 500);
        allow update: if isOwner(resource.data.userId);
        allow delete: if isOwner(resource.data.userId);
      }
    }

    // Top-level Comments collection
    match /comments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.userId) &&
                       isValidString(request.resource.data.text, 1, 500);
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // Top-level Likes collection (for easier querying)
    match /likes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Top-level Saves collection
    match /saves/{saveId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Saved posts collection (legacy/specific user view)
    match /savedPosts/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }

    // Follows collection
    match /follows/{followId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.followerId);
      allow delete: if isAuthenticated() && isOwner(resource.data.followerId);
    }

    // Followers collection (denormalized for performance)
    match /followers/{followId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Allow updates from cloud functions or client denormalization
    }

    // Following collection (denormalized for performance)
    match /following/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Allow updates from cloud functions or client denormalization
    }

    // Messages/Conversations collection
    match /conversations/{conversationId} {
      allow read: if isAuthenticated(); // Temporary relaxation to debug query
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                       resource.data.participants is list &&
                       request.auth.uid in resource.data.participants;
    }

    // Top-level Messages collection
    match /messages/{messageId} {
      allow read: if isAuthenticated(); // We rely on query filters (conversationId) for now
      allow create: if isAuthenticated() && isOwner(request.resource.data.senderId);
      allow update: if isOwner(resource.data.senderId);
      allow delete: if isOwner(resource.data.senderId);
    }

    // Conversation Stats collection (gamification)
    match /conversationStats/{statsId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }

    // User progress collection (roadmaps, courses, achievements)
    match /userProgress/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId); // Allow users to create their own progress doc
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    // Roadmaps collection (user-generated roadmaps)
    match /roadmaps/{roadmapId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // Courses collection
    match /courses/{courseId} {
      allow read: if isAuthenticated(); // Anyone authenticated can read courses
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || 
                        request.auth.uid in resource.data.collaborators);
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Achievements collection (user achievements)
    match /achievements/{userId} {
      allow read: if isAuthenticated(); // Anyone can view achievements
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    // Challenges collection
    match /challenges/{challengeId} {
      allow read: if isAuthenticated();
      allow create: if false; // Only admins can create (use Cloud Functions)
      allow update: if isAuthenticated(); // For joining challenges
      allow delete: if false; // Only admins can delete
    }

    // Leaderboard collection
    match /leaderboard/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
    }

    // Notifications collection (Top-level)
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated(); // Anyone can create a notification
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid; // For marking as read
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Groups collection
    match /groups/{groupId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.createdBy);
      allow update: if isAuthenticated() && 
                       resource.data.createdBy == request.auth.uid ||
                       request.auth.uid in resource.data.admins;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      
      // Group members
      match /members/{memberId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow delete: if isAuthenticated() && 
                         (resource.data.userId == request.auth.uid || // Self-leave
                          get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid); // Admin remove
      }
      
      // Group posts
      match /posts/{postId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && 
                         isOwner(request.resource.data.userId);
        allow update: if isOwner(resource.data.userId);
        allow delete: if isOwner(resource.data.userId) ||
                         get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid;
      }
    }

    // Projects collection
    match /projects/{projectId} {
      allow read: if isAuthenticated(); // Anyone can view projects
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Analytics collection (read-only for users)
    match /analytics/{document=**} {
      allow read: if false; // Only admins via Cloud Functions
      allow write: if false; // Only Cloud Functions
    }

    // Admin collection (restricted)
    match /admin/{document=**} {
      allow read: if false; // Only admin SDK
      allow write: if false; // Only admin SDK
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
