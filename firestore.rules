rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidString(value, minLen, maxLen) {
      return value is string && value.size() >= minLen && value.size() <= maxLen;
    }
    
    function isValidUsername(username) {
      return username is string && 
             username.size() >= 3 && 
             username.size() <= 30 &&
             username.matches('^[a-zA-Z0-9_]+$');
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId) && 
                       isValidUsername(request.resource.data.username) &&
                       isValidString(request.resource.data.name, 1, 100);
      allow update: if isOwner(userId) &&
                       // Prevent changing critical fields
                       request.resource.data.uid == resource.data.uid &&
                       (!('username' in request.resource.data.diff(resource.data).affectedKeys()) ||
                        isValidUsername(request.resource.data.username));
      allow delete: if isOwner(userId);
    }

    // Usernames collection (for unique username lookup)
    match /usernames/{username} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       isValidUsername(username) &&
                       request.resource.data.uid == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.uid == request.auth.uid;
    }

    // Posts collection
    match /posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.userId) &&
                       isValidString(request.resource.data.content.text, 0, 500) &&
                       request.resource.data.createdAt == request.time;
      allow update: if isOwner(resource.data.userId) &&
                       // Prevent changing ownership
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.username == resource.data.username;
      allow delete: if isOwner(resource.data.userId);
      
      // Post likes subcollection
      match /likes/{likeId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
        allow delete: if isAuthenticated() && isOwner(resource.data.userId);
      }
      
      // Post comments subcollection
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && 
                         isOwner(request.resource.data.userId) &&
                         isValidString(request.resource.data.text, 1, 500);
        allow update: if isOwner(resource.data.userId);
        allow delete: if isOwner(resource.data.userId);
      }
    }

    // Saved posts collection
    match /savedPosts/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }

    // Follows collection
    match /follows/{followId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.followerId) &&
                       request.resource.data.followerId != request.resource.data.followingId;
      allow delete: if isAuthenticated() && isOwner(resource.data.followerId);
    }

    // Followers collection (denormalized for performance)
    match /followers/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Following collection (denormalized for performance)
    match /following/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Messages/Conversations collection
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants &&
                       request.resource.data.participants.size() >= 2 &&
                       request.resource.data.participants.size() <= 10;
      allow update: if isAuthenticated() && 
                       request.auth.uid in resource.data.participants;
      allow delete: if false; // Prevent deletion of conversations
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
                       request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        allow create: if isAuthenticated() && 
                         request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants &&
                         isOwner(request.resource.data.senderId) &&
                         isValidString(request.resource.data.text, 1, 2000);
        allow update: if isOwner(resource.data.senderId); // For edit/reactions
        allow delete: if isOwner(resource.data.senderId);
      }
    }

    // User progress collection (roadmaps, courses, achievements)
    match /userProgress/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }

    // Roadmaps collection (user-generated roadmaps)
    match /roadmaps/{roadmapId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // Courses collection
    match /courses/{courseId} {
      allow read: if isAuthenticated(); // Anyone authenticated can read courses
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || 
                        request.auth.uid in resource.data.collaborators);
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Achievements collection (user achievements)
    match /achievements/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // Challenges collection
    match /challenges/{challengeId} {
      allow read: if isAuthenticated();
      allow create: if false; // Only admins can create (use Cloud Functions)
      allow update: if isAuthenticated(); // For joining challenges
      allow delete: if false; // Only admins can delete
    }

    // Leaderboard collection
    match /leaderboard/{userId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions can update
    }

    // Notifications collection
    match /notifications/{userId} {
      allow read: if isOwner(userId);
      allow write: if isAuthenticated(); // Others can create notifications for user
      
      match /items/{notificationId} {
        allow read: if isOwner(userId);
        allow create: if isAuthenticated();
        allow update: if isOwner(userId); // For marking as read
        allow delete: if isOwner(userId);
      }
    }

    // Groups collection
    match /groups/{groupId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.createdBy);
      allow update: if isAuthenticated() && 
                       resource.data.createdBy == request.auth.uid ||
                       request.auth.uid in resource.data.admins;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      
      // Group members
      match /members/{memberId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow delete: if isAuthenticated() && 
                         (resource.data.userId == request.auth.uid || // Self-leave
                          get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid); // Admin remove
      }
      
      // Group posts
      match /posts/{postId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && 
                         isOwner(request.resource.data.userId);
        allow update: if isOwner(resource.data.userId);
        allow delete: if isOwner(resource.data.userId) ||
                         get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid;
      }
    }

    // Projects collection
    match /projects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // Analytics collection (read-only for users)
    match /analytics/{document=**} {
      allow read: if false; // Only admins via Cloud Functions
      allow write: if false; // Only Cloud Functions
    }

    // Admin collection (restricted)
    match /admin/{document=**} {
      allow read: if false; // Only admin SDK
      allow write: if false; // Only admin SDK
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
